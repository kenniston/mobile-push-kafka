version: '3.5'

volumes:
  graylog-mongo-data:
  graylog-data:
  graylog-elastic-data:

networks:
  mobilepush:

services:
  zookeeper:
    image: zookeeper:3.6.2
    container_name: zookeper-service
    restart: always
    ports:
      - 2181:2181
    environment:
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - mobilepush

  kafka:
    build:
      context: ./kafka
      dockerfile: Dockerfile
    image: kenniston/kafka:latest
    container_name: kafka-service
    ports:
      - 9092:9092
      - 8082:8082
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_HOST_NAME: 192.168.1.111
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CREATE_TOPICS: "MobileSendPush:4:1,MobilePushResult:4:1"
      EXTRA_ARGS: -javaagent:/usr/app/jmx_prometheus_javaagent.jar=8082:/usr/app/prom-jmx-agent-config.yml
    networks:
      - mobilepush
    depends_on:
      - zookeeper

  kafdrop:
    image: obsidiandynamics/kafdrop:3.27.0
    container_name: kafdrop-service
    ports:
      - 19000:9000
    environment:
      KAFKA_BROKERCONNECT: kafka:9092    
    networks: 
      - mobilepush
    depends_on:
      - kafka
    
  prometheus:
    build:
      context: ./prometheus
      dockerfile: Dockerfile
    image: kenniston/prometheus:latest
    container_name: prometheus-service
    ports:
      - "9090:9090"
    networks:
      - mobilepush
    depends_on:
      - kafka

  grafana:
    image: grafana/grafana:7.3.7
    container_name: grafana-service
    ports:
      - "3000:3000"
    networks:
      - mobilepush
    depends_on:
      - prometheus
  
  mongo:
    image: mongo:4.2
    container_name: mongo
    volumes:
      - graylog-mongo-data:/data/db
    networks:
      - mobilepush

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.0
    container_name: elasticsearch
    volumes:
      - graylog-elastic-data:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    environment:
      http.host: 0.0.0.0
      discovery.type: single-node
      ES_JAVA_OPTS: -Xms512m -Xmx512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: 1g
    networks:
      - mobilepush

  graylog:
    image: graylog/graylog:4.0.2
    container_name: graylog
    volumes:
      - graylog-data:/usr/share/graylog/data
    ports:
      - 5555:5555/udp     # Syslog UDP
      - 6666:6666/udp     # Syslog UDP
      - 9000:9000         # Graylog web interface and REST API
      - 12201:12201       # GELF TCP
      - 12201:12201/udp   # GELF TCP
      - 1514:1514         # Syslog TCP
      - 1514:1514/udp     # Syslog UDP
    restart: always
    environment:
      GRAYLOG_HTTP_EXTERNAL_URI: http://localhost:9000/
      GRAYLOG_ROOT_PASSWORD_SHA2: 8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
      GRAYLOG_ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      GRAYLOG_ELASTICSEARCH_VERSION: 7
    networks:
      - mobilepush
    depends_on:
     - mongo
     - elasticsearch

  # golang-sender:
  #   build:
  #     context: ./golang
  #     dockerfile: Dockerfile
  #   image: golang-sender:latest
  #   container_name: golang-sender-service
  #   stdin_open: true
  #   tty: true
  #   ports:
  #     - "6001:6001"
  #   environment:
  #     - SRV_LOG_LEVEL=debug
  #   restart: on-failure:3
  #   networks:
  #     - mobilepush